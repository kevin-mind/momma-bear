name: Merge Queue Deployment

on:
  merge_group:
    types: [checks_requested]

jobs:
  ci:
    name: Run CI Checks
    uses: ./.github/workflows/ci.yml

  deploy-production:
    name: Deploy to Production
    needs: ci
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.merge_group.head_sha }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '18'

      - name: Authenticate with Shopify CLI
        uses: ./.github/actions/setup-shopify-cli
        with:
          auth-token: ${{ secrets.SHOPIFY_CLI_AUTH_TOKEN }}
          store-url: ${{ secrets.SHOPIFY_STORE_URL }}
          access-token: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}

      - name: Deploy to production
        id: deploy
        env:
          SHOPIFY_CLI_AUTH_TOKEN: ${{ secrets.SHOPIFY_CLI_AUTH_TOKEN }}
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE_URL }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        uses: ./.github/actions/deploy
        with:
          token: ${{ secrets.SHOPIFY_HYDROGEN_DEPLOYMENT_TOKEN }}

      - name: Get production URL
        id: production-url
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE_URL }}
        run: |
          PRODUCTION_URL="${SHOPIFY_STORE_URL:-${{ secrets.PRODUCTION_URL }}}"
          if [ -z "$PRODUCTION_URL" ]; then
            echo "Warning: Production URL not set. Using default."
            PRODUCTION_URL="https://production.example.com"
          fi
          echo "url=$PRODUCTION_URL" >> $GITHUB_OUTPUT
          echo "deployment-sha=${{ github.event.merge_group.head_sha }}" >> $GITHUB_OUTPUT

      - name: Wait for deployment to be ready
        run: |
          sleep 30

      - name: Run E2E tests against production
        uses: ./.github/actions/e2e-tests
        with:
          base-url: ${{ steps.production-url.outputs.url }}

      - name: Save deployment info for rollback
        if: success()
        run: |
          echo "${{ steps.production-url.outputs.deployment-sha }}" > .deployment-sha
          echo "${{ steps.production-url.outputs.url }}" > .deployment-url

      - name: Trigger rollback workflow on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // The rollback workflow will be triggered automatically via workflow_run event
            // when this workflow fails. We'll also create a notification here.
            
            const body = `‚ùå **Deployment Failed**
            
            The deployment to production failed during E2E testing.
            
            **Commit SHA:** ${{ github.event.merge_group.head_sha }}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            The rollback workflow should trigger automatically. If not, you can manually trigger it from the Actions tab.`;
            
            // Try to create a comment on the main branch (if possible)
            // Note: This may not work for merge groups, but provides visibility
            console.log('Deployment failed - rollback workflow should trigger automatically');
            
            // Optionally, you could create a GitHub issue or use repository_dispatch
            // to trigger the rollback workflow more reliably

